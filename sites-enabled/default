upstream backend {
     ip_hash;    
    # NOTE: max_fails=0 has been removed from all servers to enable health checks
    server 10.0.10.132:8050;
    server 10.0.10.138:8050;
    server 10.0.10.105:8050;

    server 10.0.10.132:8052;
    server 10.0.10.138:8052;
    server 10.0.10.105:8052;

    server 10.0.10.132:8006;
    server 10.0.10.138:8006;
    server 10.0.10.105:8006;

    server 10.0.10.132:8042;
    server 10.0.10.138:8042;
    server 10.0.10.105:8042;

    server 10.0.10.132:8010;
    server 10.0.10.138:8010;
    server 10.0.10.105:8010;

    server 10.0.10.132:8012;
    server 10.0.10.138:8012;
    server 10.0.10.105:8012;

    server 10.0.10.132:8014;
    server 10.0.10.138:8014;
    server 10.0.10.105:8014;

    server 10.0.10.132:8016;
    server 10.0.10.138:8016;
    server 10.0.10.105:8016;

    server 10.0.10.132:8018;
    server 10.0.10.138:8018;
    server 10.0.10.105:8018;

    server 10.0.10.132:8020;
    server 10.0.10.138:8020;
    server 10.0.10.105:8020;
    keepalive 8;
}

server {
    sendfile on;
    types_hash_max_size 4096;

    listen 8002 default_server;
    # listen [::]:8002 default_server;

    location / {
        proxy_next_upstream error timeout invalid_header http_404 http_500 http_502 http_503 http_504;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_buffer_size 128k;
        proxy_buffers 256 128k;
        proxy_read_timeout 60s; # Changed from 10m to a more reasonable value
        proxy_pass http://backend;
    }
}

upstream backend2 {
    ip_hash;
    # NOTE: max_fails=0 has been removed from all servers to enable health checks
    server 10.0.10.132:8051;
    server 10.0.10.138:8051;
    server 10.0.10.105:8051;

    server 10.0.10.132:8053;
    server 10.0.10.138:8053;
    server 10.0.10.105:8053;

    server 10.0.10.132:8007;
    server 10.0.10.138:8007;
    server 10.0.10.105:8007;

    server 10.0.10.132:8043;
    server 10.0.10.138:8043;
    server 10.0.10.105:8043;

    server 10.0.10.132:8011;
    server 10.0.10.138:8011;
    server 10.0.10.105:8011;

    server 10.0.10.132:8013;
    server 10.0.10.138:8013;
    server 10.0.10.105:8013;

    server 10.0.10.132:8015;
    server 10.0.10.138:8015;
    server 10.0.10.105:8015;

    server 10.0.10.132:8017;
    server 10.0.10.138:8017;
    server 10.0.10.105:8017;

    server 10.0.10.132:8019;
    server 10.0.10.138:8019;
    server 10.0.10.105:8019;

    server 10.0.10.132:8021;
    server 10.0.10.138:8021;
    server 10.0.10.105:8021;
    keepalive 8;
}

server {
    listen 8003 default_server;
    # listen [::]:8003 default_server;

    location / {
        proxy_read_timeout 60s; # Changed from 10m to a more reasonable value
        proxy_next_upstream error timeout invalid_header http_404 http_500 http_502 http_503 http_504;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_buffer_size 128k;
        proxy_buffers 256 128k;
        proxy_pass http://backend2;
    }
}

upstream moneyserver {
    server 10.0.10.132:8008;
    # server 159.69.169.111:8008;
    # server 10.0.10.126:8008;
}

server {
    listen 8008 default_server;
    # listen [::]:8008 default_server;

    location / {
        proxy_pass http://moneyserver;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_buffer_size 128k;
        proxy_buffers 256 128k;
    }
}
